#!/bin/bash
set -x

while [ "${#}" -gt 0 ]; do
	case "${1}" in
		"-c"|"--compile-only")
			export COMPILE_ONLY=1
			shift
			;;
		"-n"|"--notests")
			NOTESTS=1
			shift
			;;
		*)
			echo "Unknown option '${1}'." 1>&2
			exit 1
			;;
	esac
done

cat /proc/self/fdinfo/1
python -c "import fcntl; fcntl.fcntl(1, fcntl.F_SETFL, 0)"
cat /proc/self/fdinfo/1
start=`date +%s`

fini()
{
	dmesg
	date

	if [ -f /proc/lockdep ]; then
		# net-next: WARNING: CPU: 0 PID: 1544 at net/ipv4/tcp_input.c:889
		dmesg | grep -v "can't dereference iret registers at.*entry_SYSCALL_64_fastpath" | grep -v "WARNING: stack recursion on stack type" | grep WARNING && exit 1 || true
	fi

	cat /proc/sys/kernel/tainted
	[ "`cat /proc/sys/kernel/tainted`" = "0" ] ||	exit 1

	exit 0
}

check_travis_timeout()
{
    local cur

    cur=`date +%s`

    echo elapsed time: $((cur - start))
#    test $((cur - start)) -lt $((40 * 60)) || fini
    [ "`cat /proc/sys/kernel/tainted`" = "0" ] || fini
    if [ -f /proc/lockdep ]; then
	dmesg | grep -v "can't dereference iret registers at.*entry_SYSCALL_64_fastpath" | grep -v "WARNING: stack recursion on stack type" | grep WARNING && fini || true
    fi
}

cd ../../
set -m
./scripts/travis/kexec.sh prep > kexec-prep.log 2>&1 &

set -x -e

python -c "import fcntl; fcntl.fcntl(1, fcntl.F_SETFL, 0)"

cat /proc/cmdline
cat /proc/self/mountinfo

TRAVIS_PKGS="protobuf-c-compiler libprotobuf-c0-dev libaio-dev
		libprotobuf-dev protobuf-compiler
		libcap-dev libnl-3-dev gdb bash python-protobuf python-yaml
		libnet-dev util-linux asciidoctor libnl-route-3-dev
		time ccache
		libbsd-dev
		kexec-tools libssl-dev libelf-dev strace"

X86_64_PKGS="gcc-multilib"

UNAME_M=`uname -m`

if [ "$UNAME_M" != "x86_64" ]; then
	# For Travis only x86_64 seems to be baremetal. Other
	# architectures are running in unprivileged LXD containers.
	# That seems to block most of CRIU's interfaces.
	SKIP_TRAVIS_TEST=1
fi

travis_prep () {
	[ -n "$SKIP_TRAVIS_PREP" ] && return

	cd ../../

	# This can fail on aarch64 travis
	service apport stop || :

	CC=gcc
	# clang support
	if [ "$CLANG" = "1" ]; then
		TRAVIS_PKGS="$TRAVIS_PKGS clang"
		CC=clang
	fi

	[ -n "$GCOV" ] && {
		apt-add-repository -y "ppa:ubuntu-toolchain-r/test"
		apt-get update -yq
		apt-get -yq --no-install-suggests --no-install-recommends --force-yes install g++-7
		CC=gcc-7
	}

	# ccache support, only enable for non-GCOV case
	if [ "$CCACHE" = "1" -a -z "$GCOV" ]; then
		# ccache is installed by default, need to set it up
		export CCACHE_DIR=$HOME/.ccache
		mkdir -p $CCACHE_DIR
		[ "$CC" = "clang" ] && export CCACHE_CPP2=yes
		# uncomment the following to get detailed ccache logs
		#export CCACHE_LOGFILE=$HOME/ccache.log
		CC="ccache $CC"
	fi

	# Do not install x86_64 specific packages on other architectures
	if [ "$UNAME_M" = "x86_64" ]; then
		TRAVIS_PKGS="$TRAVIS_PKGS $X86_64_PKGS"
	fi

	apt-get update -y
	apt-get install -y --no-install-recommends $TRAVIS_PKGS || { echo $?; exit 1 }
	# travis is based on 14.04 and that does not have python
	# packages for future and ipaddress (16.04 has those packages)
	pip install junit-xml future ipaddress
	chmod a+x $HOME
	pip install dropbox
	export CCACHE_DIR="/home/travis/.ccache"
	export CC="ccache gcc"
	export CXX="ccache g++"
	export PATH="/usr/lib/ccache:$PATH"
}

cat /proc/self/fdinfo/1
travis_prep
cat /proc/self/fdinfo/1

export GCOV
umask 0000
make -j4 ${MAKE_VARS}
ccache -s
cat /proc/self/fdinfo/1

./criu/criu check --extra --all || echo $?
make -j4 ${MAKE_VARS} -C test/zdtm
python test/zdtm.py run -t zdtm/static/env00

cat /proc/self/fdinfo/1

date
wait # for kexec.sh prep to finish
cat kexec-prep.log
./scripts/travis/kexec.sh

if [ -n "$COMPILE_ONLY" ]; then
	exit 0
fi

cat /proc/self/fdinfo/1

dmesg
if [ -n "$NOTESTS" ]; then
	exit 0
fi

cat /proc/self/fdinfo/1
ulimit -c unlimited
echo "|`pwd`/test/abrt.sh %P %p %s %e" > /proc/sys/kernel/core_pattern
make -j4 ${MAKE_VARS} -C test/zdtm
cat /proc/self/fdinfo/1

check_travis_timeout

cat /proc/self/fdinfo/1
umask 0000
./criu/criu check
./criu/criu check --all || echo $?
./criu/criu cpuinfo dump
./criu/criu cpuinfo check

export SKIP_PREP=1
cat /proc/self/fdinfo/1

chmod a+w -R .
chmod 0777 test/
chmod 0777 test/zdtm/static
chmod 0777 test/zdtm/transition
cat /proc/self/fdinfo/1

check_travis_timeout
./test/zdtm.py run -a -p 4 --keep-going
cat /proc/self/fdinfo/1

check_travis_timeout
bash ./test/jenkins/criu-fault.sh

check_travis_timeout
bash ./test/jenkins/criu-fcg.sh
check_travis_timeout
bash ./test/jenkins/criu-inhfd.sh

check_travis_timeout
make -C test/others/mnt-ext-dev/ run
#make -C test/others/exec/ run
make -C test/others/make/ run CC="$CC"
make -C test/others/shell-job/ run
make -C test/others/rpc/ run ||
( for i in `find test/others/rpc/ -name '*.log'`; do echo; echo "======"; echo $i; echo "======"; cat $i; done; exit 1)

check_travis_timeout
./test/zdtm.py run -t zdtm/static/env00 --sibling

check_travis_timeout
./test/zdtm.py run -t zdtm/transition/maps007 --pre 2 --dedup

check_travis_timeout
./test/zdtm.py run -t zdtm/transition/maps007 --pre 2 --noauto-dedup

check_travis_timeout
./test/zdtm.py run -t zdtm/transition/maps007 --pre 2 --page-server

check_travis_timeout
./test/zdtm.py run -t zdtm/transition/maps007 --pre 2 --page-server --dedup

check_travis_timeout
./test/zdtm.py run -t zdtm/static/socket-tcp-local --norst

check_travis_timeout
ip net add test
./test/zdtm.py run -t zdtm/static/env00 -f h --join-ns

check_travis_timeout
# RPC testing
./test/zdtm.py run -t zdtm/static/env00 --rpc		# Basic
./test/zdtm.py run -t zdtm/static/env00 --rpc --pre 2 --page-server
./test/zdtm.py run -t zdtm/static/ptrace_sig -f h --rpc # Error handling (crfail test)

./test/zdtm.py run --empty-ns -T zdtm/static/socket-tcp*-local --iter 2

./test/zdtm.py run -t zdtm/static/env00 -k always
./test/crit-recode.py

make -C test/others/shell-job

check_travis_timeout
./test/zdtm.py run -p 2 -T zdtm/static/maps* --lazy-pages
./test/zdtm.py run -t zdtm/static/env00 --lazy-pages --pre 2
./test/zdtm.py run -t zdtm/static/env00 --remote-lazy-pages

check_travis_timeout
git clean -dxf test/zdtm
make V=1 COMPAT_TEST=y -C test/zdtm/static/ env00
./test/zdtm.py run -t zdtm/static/env00 -f h

dmesg

if [ -f /proc/lockdep ]; then
	cat /proc/lockdep | grep WARNING && exit 1 || true
fi

cat /proc/sys/kernel/tainted
[ "`cat /proc/sys/kernel/tainted`" = "0" ] ||	exit 1

#check_travis_timeout
#pip install flake8
#make lint
#
## Check that help output fits into 80 columns
#WIDTH=$(./criu/criu --help | wc --max-line-length)
#if [ "$WIDTH" -gt 80 ]; then
#	echo "criu --help output does not obey 80 characters line width!"
#	exit 1
#fi
