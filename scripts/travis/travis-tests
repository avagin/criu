#!/bin/sh
set -x -e

ulimit -c unlimited

cd ../../

cat /proc/cpuinfo

sudo /etc/init.d/apparmor stop || true
sudo systemctl stop apparmor.service || true
sudo update-rc.d -f apparmor remove || true

service apport stop
echo "|`pwd`/test/abrt.sh %P %p %s %e" > /proc/sys/kernel/core_pattern

apt-get update -qq
apt-get install -qq protobuf-c-compiler libprotobuf-c0-dev libaio-dev	\
	libprotobuf-dev protobuf-compiler python-ipaddr libcap-dev	\
	libnl-3-dev gcc-multilib libc6-dev-i386 gdb bash
chmod a+x $HOME
uname -a
make
make -C test/zdtm

./criu/criu check
./criu/criu check --all || echo $?
./criu/criu cpuinfo dump
./criu/criu cpuinfo check

umask 0000
export SKIP_PREP=1

echo 1 > /sys/kernel/debug/tracing/events/exceptions/enable
echo 1 > /sys/kernel/debug/tracing/events/signal/enable
ret=0
while :; do ./test/zdtm.py run -a -x 'cgroup*' -p 2 --norst || { ret=1; break; }; done
[ $ret -ne 0 ] && {
cat /sys/kernel/debug/tracing/trace
exit 1
}

bash ./test/jenkins/criu-fault.sh
bash ./test/jenkins/criu-fcg.sh
bash ./test/jenkins/criu-inhfd.sh

make -C test/others/mnt-ext-dev/ run
make -C test/others/exec/ run

./test/zdtm.py run -t zdtm/static/env00 --sibling

./test/zdtm.py run -t zdtm/transition/maps007 --pre 2 --dedup
./test/zdtm.py run -t zdtm/transition/maps007 --pre 2 --page-server

./test/zdtm.py run -t zdtm/static/socket-tcp-local --norst

ip net add test
./test/zdtm.py run -t zdtm/static/env00 -f h --join-ns

pip install flake8
make lint
