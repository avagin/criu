ARG CC=gcc
ARG ENV1=FOOBAR

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -qy --no-install-recommends \
	ccache \
	libnet-dev \
	libnl-route-3-dev \
	$CC \
	bsdmainutils \
	build-essential \
	git-core \
	iptables \
	libaio-dev \
	libcap-dev \
	libgnutls28-dev \
	libgnutls30 \
	libnl-3-dev \
	libprotobuf-c-dev \
	libprotobuf-dev \
	libselinux-dev \
	pkg-config \
	protobuf-c-compiler \
	protobuf-compiler \
	python3-minimal \
	python3-future

RUN echo "deb http://archive.ubuntu.com/ubuntu groovy universe" >> /etc/apt/sources.list && \
  echo "deb http://archive.ubuntu.com/ubuntu focal main universe" >> /etc/apt/sources.list

# libbpf depends on libc >= 2.26
RUN apt-get update && apt-get install -t focal -y \
	libc6=2.31-0ubuntu9

RUN apt-get update && apt-get install -t groovy -y \
	libbpf0 	\
	libbpf-dev

COPY . /criu
WORKDIR /criu
ENV CC="ccache $CC" CCACHE_DIR=/tmp/.ccache CCACHE_NOCOMPRESS=1 $ENV1=yes

RUN mv .ccache /tmp && make mrproper && ccache -s && \
	date && \
# Check single object build
	make -j $(nproc) CC="$CC" criu/parasite-syscall.o && \
# Compile criu
	make -j $(nproc) CC="$CC" && \
	date && \
# Check that "make mrproper" works
	make mrproper && ! git clean -ndx --exclude=scripts/build \
	--exclude=.config --exclude=test | grep .

# Compile tests
RUN date && make -j $(nproc) CC="$CC" -C test/zdtm && date

#RUN make test/compel/handle_binary && ./test/compel/handle_binary
